<%- include('../layouts/header.ejs') -%>


<div class="container">
  <div class="row">
      <div class="col-md-6 offset-md-3">
          <div class="otp-form">
              <h2 class="text-center mb-4">OTP Verification</h2>
              
              <form id="form" method="post" action="/verify">
                  <div class="mb-3">
                      <label for="otp" class="form-label">Enter 4-digit OTP</label>
                      <input type="text" class="form-control" name="otp" id="otp" maxlength="4" pattern="\d{4}" required>
                      <div class="invalid-feedback">
                          Please enter a valid 4-digit OTP.
                      </div>
                  </div>
                  
                  <button type="submit" class="btn btn-primary w-100">Verify OTP</button>

                  <div class="text-right mt-2">
                    <span id="timer" style="color: red; font-size: 14px;"></span>
                    
                </div>
                <input type="button" value="Resend OTP" class="btn btn-secondary " name="resendOtp" id="resendOtp" disabled>
                <div id="resendMessage" class="mt-2"></div>
              </form>
              
          </div>
          <% if (message) { %>
            <div class="alert text-danger">
                <%= message %>
            </div>
            <% } %>
      </div>
  </div>
</div>

<script>
    let timerSeconds = 60; // 1 minute
    let timerInterval;

    function startTimer() {
        timerInterval = setInterval(function () {
            if (timerSeconds > 0) {
                document.getElementById('timer').innerText = `Resend in ${timerSeconds} seconds`;
                timerSeconds--;
            } else {
                document.getElementById('timer').innerText = '';
                clearInterval(timerInterval);
                // Enable the "Resend OTP" button after the timer expires
                document.getElementById('resendOtp').removeAttribute('disabled');
            }
        }, 1000);
    }

    document.getElementById('resendOtp').addEventListener('click', function () {
    this.setAttribute('disabled', true);
    fetch('/resendOtp', {
        method: 'GET',
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        const contentType = response.headers.get('content-type');
        if (contentType && contentType.includes('application/json')) {
            // If the content type is JSON, parse the response as JSON
            return response.json();
        } else {
            // If the content type is not JSON, handle it as plain text
            return response.text();
        }
    })
    .then(data => {
        // Handle the response, update UI if needed
        console.log('OTP resent successfully', data);
        timerSeconds = 60; // Reset the timer
        startTimer();
        document.getElementById('resendMessage').innerText = 'OTP resent successfully. Check your email.';
    })
    .catch(error => {
        console.error('Error resending OTP', error);

        // Check if the error is not an actual error, but a successful response with an error message
        if (error instanceof Error) {
            document.getElementById('resendMessage').innerText = 'Error resending OTP. Please try again.';
        } else {
            // Handle the case where the server responds with an error message
            document.getElementById('resendMessage').innerText = error.message;
        }
    });
});
startTimer();
</script>

<!-- Bootstrap JS and Popper.js (required for Bootstrap) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <%- include('../layouts/footer.ejs') -%>
